<!DOCTYPE html>
<html>
<head>
    <title>portfolio-item-cumulative-flow</title>

    <script type="text/javascript" src="/apps/2.0rc2/sdk.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc2/lib/analytics/analytics-all.js"></script>
    <script type="text/javascript" src="http://momentjs.com/downloads/moment.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:{},config:{defaultSettings:{itemtype:"Goal",items:"G1076",unittype:"Count",stateField:"ScheduleState"}},getSettingsFields:function(){return[{name:"itemtype",xtype:"rallytextfield",label:"Item Type eg. 'Initiaitve'"},{name:"items",xtype:"rallytextfield",label:"Portfolio Items (comma separated)"},{name:"unittype",xtype:"rallytextfield",label:"'Points' or 'Count'"},{name:"stateField",xtype:"rallytextfield",label:"Story State Field"}]},launch:function(){console.log("launch"),app=this,app.portfolioItems=app.getSetting("items").split(","),app.itemtype=app.getSetting("itemtype"),app.stateField=app.getSetting("stateField"),app.unittype=app.getSetting("unittype"),app.portfolioItems=""!=app.portfolioItems?app.portfolioItems:[""],""!=app.portfolioItems&&0!=app.portfolioItems.length&&(Rally.data.ModelFactory.getModel({type:"HierarchicalRequirement",scope:this,success:function(model){var store=model.getField(app.stateField).getAllowedValueStore();store.load({scope:this,callback:function(records,operation,success){app.fieldAllowedValues=_.map(records,function(r){return r.get("StringValue")}),console.log("Allowed Values:",app.fieldAllowedValues),app.createChart()}})}}),console.log("end launch"))},createChart:function(){var configs=_.map(app.portfolioItems,function(item){return{model:"PortfolioItem/"+app.itemtype,fetch:["FormattedID","ObjectID","Name","PlannedStartDate","PlannedEndDate"],filters:[{property:"FormattedID",operator:"=",value:item}]}});app.myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."}),app.myMask.show(),async.map(configs,app.wsapiQuery,function(err,results){var pis=_.map(results,function(r){return r[0]});console.log("pis",pis),app.validateItems(app.portfolioItems,pis)!==!1&&async.map([pis],app.snapshotquery,function(err,results){console.log("snapshots",results[0].length);var m=_.min(results[0],function(s){return Rally.util.DateTime.fromIsoString(s._ValidFrom)});console.log("min:",m);var renderer=Ext.create("CumulativeFlowRenderer",{items:pis,snapshots:results[0],stateField:app.stateField,states:app.fieldAllowedValues,unitType:app.unittype,title:pis[0].get("FormattedID")+"-"+pis[0].get("Name")}),chart=app.down("#chart1");null!==chart&&chart.removeAll(),chart=renderer.createChart("chart1","CumulativeFlow"),app.add(chart),chart=app.down("#chart1");var p=Ext.get(chart.id);elems=p.query("div.x-mask"),_.each(elems,function(e){e.remove()});var elems=p.query("div.x-mask-msg");_.each(elems,function(e){e.remove()}),app.myMask.hide()})})},validateItems:function(ids,items){var valid=!0;return(null===items||void 0===items)&&(console.log("items not found"),app.myMask.hide(),Rally.ui.notify.Notifier.show({message:"Items Not found!"}),valid=!1),_.each(items,function(item,x){(void 0===item||null===item)&&(console.log("id not found",ids[x]),app.myMask.hide(),Rally.ui.notify.Notifier.show({message:ids[x]+" Not found!"}),valid=!1),void 0!==item&&(null===item.get("PlannedStartDate")||null===item.get("PlannedEndDate"))&&(console.log("no start or end date ",ids[x]),app.myMask.hide(),Rally.ui.notify.Notifier.show({message:ids[x]+" does not have a planned start or end date!"}),valid=!1)}),valid},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})},snapshotquery:function(items,callback){console.log("Snapshotquery for Items",items);var item=items[0],parentId=item.get("ObjectID");console.log("item:",item,parentId);var storeConfig={find:{_TypeHierarchy:{$in:["HierarchicalRequirement"]},_ItemHierarchy:{$in:[parentId]},_ProjectHierarchy:{$in:[app.getContext().getProject().ObjectID]},__At:"current",Children:null},autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:["ObjectID"]};storeConfig.listeners={scope:this,load:function(store,data,success){var data=_.pluck(data,"data");console.log("Outer Query Snapshots:",data.length);var storyIds=_.pluck(data,"ObjectID"),snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",{find:{ObjectID:{$in:storyIds}},autoLoad:!0,pageSize:1e3,limit:"Infinity",fetch:["ScheduleState","FormattedID","ObjectID","_ValidFrom","_ValidTo","PlanEstimate"],hydrate:["ScheduleState"],listeners:{scope:this,load:function(store,data,success){console.log("Inner Query Snapshots:",data.length),callback(null,_.pluck(data,"data"))}}})}};var snapshotStore=Ext.create("Rally.data.lookback.SnapshotStore",storeConfig)}});
                Ext.define("CumulativeFlowRenderer",function(){var self;return{config:{items:[],snapshots:[],stateField:"",states:[],unitType:"Count",title:"Portfolio Item Cumulative Flow Chart"},constructor:function(config){return self=this,this.initConfig(config),this},getCalculator:function(){return Ext.define("CumulativeFlowCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",acceptedData:[],pointsOffset:[],getMetrics:function(){var metrics=[];return _.each(self.states,function(state){metrics.push({as:state,f:"Points"===self.unitType?"filteredSum":"filteredCount",field:"Points"===self.unitType?"PlanEstimate":"ObjectID",filterField:self.stateField,filterValues:[state]})}),console.log("metrics",metrics),metrics}}),Ext.create("CumulativeFlowCalculator")},getChartConfig:function(){var lumenize=window.parent.Rally.data.lookback.Lumenize,snapShotData=self.snapshots,calc=self.getCalculator(),metrics=calc.getMetrics(),config={deriveFieldsOnInput:[],metrics:metrics,summaryMetricsConfig:[],deriveFieldsAfterSummary:calc.getDerivedFieldsAfterSummary(),granularity:lumenize.Time.DAY,tz:"America/New_York",holidays:[],workDays:"Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday"},start=_.min(_.map(self.items,function(i){return i.get("PlannedStartDate")})),end=_.max(_.map(self.items,function(i){return i.get("PlannedEndDate")})),startOnISOString=new lumenize.Time(start).getISOStringInTZ(config.tz),upToDateISOString=new lumenize.Time(end).getISOStringInTZ(config.tz),calculator=new lumenize.TimeSeriesCalculator(config);calculator.addSnapshots(snapShotData,startOnISOString,upToDateISOString);var hcConfig=[{name:"label"}];_.each(_.map(metrics,function(m){return{name:m.as,type:"area",thetitle:m.thetitle}}),function(c){hcConfig.push(c)});var hc=lumenize.arrayOfMaps_To_HighChartsSeries(calculator.getResults().seriesData,hcConfig);return _.each(metrics,function(m,i){var h=hc[i+1];_.each(h.data,function(data,x){var d=Date.parse(hc[0].data[x]);(m.start>d||d>m.end)&&(h.data[x]=null)})}),hc},createChart:function(id){var series=self.getChartConfig(),tickInterval=140>=series[1].data.length?7:series[1].data.length/10,extChart=Ext.create("Rally.ui.chart.Chart",{listeners:{},columnWidth:1,itemId:id,chartData:{categories:series[0].data,series:series.slice(1,series.length)},chartConfig:{chart:{},title:{style:{fontSize:"10px"},text:self.title,x:-20},plotOptions:{area:{stacking:"normal"},line:{events:{legendItemClick:function(a,b,c){}}},series:{marker:{radius:1}}},xAxis:{tickInterval:tickInterval,type:"datetime",labels:{formatter:function(){return Highcharts.dateFormat("%b %d",Date.parse(this.value))}}},yAxis:{title:{text:self.unitType},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{},legend:{align:"center",verticalAlign:"bottom"}}});return extChart}}});
                (function(){function r(e){var n=!1;return function(){if(n)throw Error("Callback was already called.");n=!0,e.apply(t,arguments)}}var e={},t,n;t=this,null!=t&&(n=t.async),e.noConflict=function(){return t.async=n,e};var i=function(e,t){if(e.forEach)return e.forEach(t);for(var n=0;e.length>n;n+=1)t(e[n],n,e)},s=function(e,t){if(e.map)return e.map(t);var n=[];return i(e,function(e,r,i){n.push(t(e,r,i))}),n},o=function(e,t,n){return e.reduce?e.reduce(t,n):(i(e,function(e,r,i){n=t(n,e,r,i)}),n)},u=function(e){if(Object.keys)return Object.keys(e);var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t};"undefined"!=typeof process&&process.nextTick?(e.nextTick=process.nextTick,e.setImmediate="undefined"!=typeof setImmediate?function(e){setImmediate(e)}:e.nextTick):"function"==typeof setImmediate?(e.nextTick=function(e){setImmediate(e)},e.setImmediate=e.nextTick):(e.nextTick=function(e){setTimeout(e,0)},e.setImmediate=e.nextTick),e.each=function(e,t,n){if(n=n||function(){},!e.length)return n();var s=0;i(e,function(i){t(i,r(function(t){t?(n(t),n=function(){}):(s+=1,s>=e.length&&n(null))}))})},e.forEach=e.each,e.eachSeries=function(e,t,n){if(n=n||function(){},!e.length)return n();var r=0,i=function(){t(e[r],function(t){t?(n(t),n=function(){}):(r+=1,r>=e.length?n(null):i())})};i()},e.forEachSeries=e.eachSeries,e.eachLimit=function(e,t,n,r){var i=a(t);i.apply(null,[e,n,r])},e.forEachLimit=e.eachLimit;var a=function(e){return function(t,n,r){if(r=r||function(){},!t.length||0>=e)return r();var i=0,s=0,o=0;(function u(){if(i>=t.length)return r();for(;e>o&&t.length>s;)s+=1,o+=1,n(t[s-1],function(e){e?(r(e),r=function(){}):(i+=1,o-=1,i>=t.length?r():u())})})()}},f=function(t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[e.each].concat(n))}},l=function(e,t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[a(e)].concat(n))}},c=function(t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[e.eachSeries].concat(n))}},h=function(e,t,n,r){var i=[];t=s(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n,r){i[e.index]=r,t(n)})},function(e){r(e,i)})};e.map=f(h),e.mapSeries=c(h),e.mapLimit=function(e,t,n,r){return p(t)(e,n,r)};var p=function(e){return l(e,h)};e.reduce=function(t,n,r,i){e.eachSeries(t,function(e,t){r(n,e,function(e,r){n=r,t(e)})},function(e){i(e,n)})},e.inject=e.reduce,e.foldl=e.reduce,e.reduceRight=function(t,n,r,i){var o=s(t,function(e){return e}).reverse();e.reduce(o,n,r,i)},e.foldr=e.reduceRight;var d=function(e,t,n,r){var i=[];t=s(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n&&i.push(e),t()})},function(e){r(s(i.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};e.filter=f(d),e.filterSeries=c(d),e.select=e.filter,e.selectSeries=e.filterSeries;var v=function(e,t,n,r){var i=[];t=s(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n||i.push(e),t()})},function(e){r(s(i.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};e.reject=f(v),e.rejectSeries=c(v);var m=function(e,t,n,r){e(t,function(e,t){n(e,function(n){n?(r(e),r=function(){}):t()})},function(e){r()})};e.detect=f(m),e.detectSeries=c(m),e.some=function(t,n,r){e.each(t,function(e,t){n(e,function(e){e&&(r(!0),r=function(){}),t()})},function(e){r(!1)})},e.any=e.some,e.every=function(t,n,r){e.each(t,function(e,t){n(e,function(e){e||(r(!1),r=function(){}),t()})},function(e){r(!0)})},e.all=e.every,e.sortBy=function(t,n,r){e.map(t,function(e,t){n(e,function(n,r){n?t(n):t(null,{value:e,criteria:r})})},function(e,t){if(e)return r(e);var n=function(e,t){var n=e.criteria,r=t.criteria;return r>n?-1:n>r?1:0};r(null,s(t.sort(n),function(e){return e.value}))})},e.auto=function(t,n){n=n||function(){};var r=u(t);if(!r.length)return n(null);var s={},a=[],f=function(e){a.unshift(e)},l=function(e){for(var t=0;a.length>t;t+=1)if(a[t]===e)return a.splice(t,1),void 0},c=function(){i(a.slice(0),function(e){e()})};f(function(){u(s).length===r.length&&(n(null,s),n=function(){})}),i(r,function(r){var a=t[r]instanceof Function?[t[r]]:t[r],h=function(t){var o=Array.prototype.slice.call(arguments,1);if(1>=o.length&&(o=o[0]),t){var a={};i(u(s),function(e){a[e]=s[e]}),a[r]=o,n(t,a),n=function(){}}else s[r]=o,e.setImmediate(c)},p=a.slice(0,Math.abs(a.length-1))||[],d=function(){return o(p,function(e,t){return e&&s.hasOwnProperty(t)},!0)&&!s.hasOwnProperty(r)};if(d())a[a.length-1](h,s);else{var v=function(){d()&&(l(v),a[a.length-1](h,s))};f(v)}})},e.waterfall=function(t,n){if(n=n||function(){},t.constructor!==Array){var r=Error("First argument to waterfall must be an array of functions");return n(r)}if(!t.length)return n();var i=function(t){return function(r){if(r)n.apply(null,arguments),n=function(){};else{var s=Array.prototype.slice.call(arguments,1),o=t.next();o?s.push(i(o)):s.push(n),e.setImmediate(function(){t.apply(null,s)})}}};i(e.iterator(t))()};var g=function(e,t,n){if(n=n||function(){},t.constructor===Array)e.map(t,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);1>=n.length&&(n=n[0]),t.call(null,e,n)})},n);else{var r={};e.each(u(t),function(e,n){t[e](function(t){var i=Array.prototype.slice.call(arguments,1);1>=i.length&&(i=i[0]),r[e]=i,n(t)})},function(e){n(e,r)})}};e.parallel=function(t,n){g({map:e.map,each:e.each},t,n)},e.parallelLimit=function(e,t,n){g({map:p(t),each:a(t)},e,n)},e.series=function(t,n){if(n=n||function(){},t.constructor===Array)e.mapSeries(t,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);1>=n.length&&(n=n[0]),t.call(null,e,n)})},n);else{var r={};e.eachSeries(u(t),function(e,n){t[e](function(t){var i=Array.prototype.slice.call(arguments,1);1>=i.length&&(i=i[0]),r[e]=i,n(t)})},function(e){n(e,r)})}},e.iterator=function(e){var t=function(n){var r=function(){return e.length&&e[n].apply(null,arguments),r.next()};return r.next=function(){return e.length-1>n?t(n+1):null},r};return t(0)},e.apply=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t.concat(Array.prototype.slice.call(arguments)))}};var y=function(e,t,n,r){var i=[];e(t,function(e,t){n(e,function(e,n){i=i.concat(n||[]),t(e)})},function(e){r(e,i)})};e.concat=f(y),e.concatSeries=c(y),e.whilst=function(t,n,r){t()?n(function(i){return i?r(i):(e.whilst(t,n,r),void 0)}):r()},e.doWhilst=function(t,n,r){t(function(i){return i?r(i):(n()?e.doWhilst(t,n,r):r(),void 0)})},e.until=function(t,n,r){t()?r():n(function(i){return i?r(i):(e.until(t,n,r),void 0)})},e.doUntil=function(t,n,r){t(function(i){return i?r(i):(n()?r():e.doUntil(t,n,r),void 0)})},e.queue=function(t,n){function s(t,r,s,o){r.constructor!==Array&&(r=[r]),i(r,function(r){var i={data:r,callback:"function"==typeof o?o:null};s?t.tasks.unshift(i):t.tasks.push(i),t.saturated&&t.tasks.length===n&&t.saturated(),e.setImmediate(t.process)})}void 0===n&&(n=1);var o=0,u={tasks:[],concurrency:n,saturated:null,empty:null,drain:null,push:function(e,t){s(u,e,!1,t)},unshift:function(e,t){s(u,e,!0,t)},process:function(){if(u.concurrency>o&&u.tasks.length){var e=u.tasks.shift();u.empty&&0===u.tasks.length&&u.empty(),o+=1;var n=function(){o-=1,e.callback&&e.callback.apply(e,arguments),u.drain&&0===u.tasks.length+o&&u.drain(),u.process()},i=r(n);t(e.data,i)}},length:function(){return u.tasks.length},running:function(){return o}};return u},e.cargo=function(t,n){var r=!1,o=[],u={tasks:o,payload:n,saturated:null,empty:null,drain:null,push:function(t,r){t.constructor!==Array&&(t=[t]),i(t,function(e){o.push({data:e,callback:"function"==typeof r?r:null}),u.saturated&&o.length===n&&u.saturated()}),e.setImmediate(u.process)},process:function a(){if(!r){if(0===o.length)return u.drain&&u.drain(),void 0;var e="number"==typeof n?o.splice(0,n):o.splice(0),f=s(e,function(e){return e.data});u.empty&&u.empty(),r=!0,t(f,function(){r=!1;var t=arguments;i(e,function(e){e.callback&&e.callback.apply(null,t)}),a()})}},length:function(){return o.length},running:function(){return r}};return u};var b=function(e){return function(t){var n=Array.prototype.slice.call(arguments,1);t.apply(null,n.concat([function(t){var n=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(t?console.error&&console.error(t):console[e]&&i(n,function(t){console[e](t)}))}]))}};e.log=b("log"),e.dir=b("dir"),e.memoize=function(e,t){var n={},r={};t=t||function(e){return e};var i=function(){var i=Array.prototype.slice.call(arguments),s=i.pop(),o=t.apply(null,i);o in n?s.apply(null,n[o]):o in r?r[o].push(s):(r[o]=[s],e.apply(null,i.concat([function(){n[o]=arguments;var e=r[o];delete r[o];for(var t=0,i=e.length;i>t;t++)e[t].apply(null,arguments)}])))};return i.memo=n,i.unmemoized=e,i},e.unmemoize=function(e){return function(){return(e.unmemoized||e).apply(null,arguments)}},e.times=function(t,n,r){for(var i=[],s=0;t>s;s++)i.push(s);return e.map(i,n,r)},e.timesSeries=function(t,n,r){for(var i=[],s=0;t>s;s++)i.push(s);return e.mapSeries(i,n,r)},e.compose=function(){var t=Array.prototype.reverse.call(arguments);return function(){var n=this,r=Array.prototype.slice.call(arguments),i=r.pop();e.reduce(t,r,function(e,t,r){t.apply(n,e.concat([function(){var e=arguments[0],t=Array.prototype.slice.call(arguments,1);r(e,t)}]))},function(e,t){i.apply(n,[e].concat(t))})}};var w=function(e,t){var n=function(){var n=this,r=Array.prototype.slice.call(arguments),i=r.pop();return e(t,function(e,t){e.apply(n,r.concat([t]))},i)};if(arguments.length>2){var r=Array.prototype.slice.call(arguments,2);return n.apply(this,r)}return n};e.applyEach=f(w),e.applyEachSeries=c(w),e.forever=function(e,t){function n(r){if(r){if(t)return t(r);throw r}e(n)}n()},"undefined"!=typeof define&&define.amd?define([],function(){return e}):"undefined"!=typeof module&&module.exports?module.exports=e:t.async=e})();

            Rally.launchApp('CustomApp', {
                name:"portfolio-item-cumulative-flow",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
